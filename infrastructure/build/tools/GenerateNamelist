#!/usr/bin/env python2.7
# -*- coding: utf-8 -*-
##############################################################################
# Copyright (c) 2017,  Met Office, on behalf of HMSO and Queen's Printer
# For further details please refer to the file LICENCE.original which you
# should have received as part of this distribution.
##############################################################################
'''
Reads in a namelist description file, produces a Fortran namelist module and
updates the configuration module. Files will be created in the current
directory unless commanded otherwise.
'''

from __future__ import print_function

import argparse
import os.path

from configurator import __version__
import configurator.namelistdescription as namelist
import utilities.logging as logging


def main():

    parser = argparse.ArgumentParser(add_help=False,
                                     description=__doc__)
    parser.add_argument('-help', '-h', '--help', action='help',
                        help='Show this help message and exit')
    parser.add_argument('-version', action='version',
                        version='%(prog)s {}'.format(__version__))
    parser.add_argument('-verbose', action='store_true',
                        help='Provide a running commentry')
    parser.add_argument('-directory', metavar='path', default='.',
                        help='Generated source files are put here.')
    parser.add_argument('meta_filename', metavar='description-file',
                        nargs=1, help='The metadata file to load')
    parser.add_argument('--norandom_enums',
                        help='Disables randomised enumeration values.',
                        action="store_true")

    args = parser.parse_args()

    if args.verbose:
        import sys
        logger = logging.PrintLogger(sys.stdout)
    else:
        logger = logging.NoLogger()

    description_list = []

    meta_filename = args.meta_filename[0]

    meta_parser = namelist.NamelistConfigDescription()

    # Generate namelists from the namelist configuration file.
    description_list = meta_parser.process_config(meta_filename, 
                                                  fix_enum=args.norandom_enums)

    for description in description_list:
        module_filename = os.path.join(args.directory,
                                       description.get_module_name() + '.f90')
        with open(module_filename, 'w') as module_file:
            description.write_module(module_file)


if __name__ == '__main__':
    main()
