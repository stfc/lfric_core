!-----------------------------------------------------------------------------
! (c) Crown copyright 2022 Met Office. All rights reserved.
! The file LICENCE, distributed with this code, contains details of the terms
! under which the code may be used.
!-----------------------------------------------------------------------------
!> @brief Test the final 1D FFSL flux computation in the y direction

module ffsl_flux_final_y_kernel_mod_test

  use constants_mod, only : i_def, r_tran, r_def, l_def
  use pFUnit_Mod

  implicit none

  private
  public :: test_all

  @TestCase
  type, public, extends(TestCase) :: ffsl_flux_final_y_test_type
    private
  contains
    procedure test_all
  end type ffsl_flux_final_y_test_type

contains

  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  @Test
  subroutine test_all( this )

    use, intrinsic :: iso_fortran_env,  only: real64
    use ffsl_flux_final_y_kernel_mod,   only: ffsl_flux_final_y_code
    use transport_enumerated_types_mod, only: horizontal_monotone_none

    implicit none

    class(ffsl_flux_final_y_test_type), intent(inout) :: this

    real(kind=r_tran), parameter :: tol = 1.0e-12_r_tran   ! r_tran 64-bit
    real(kind=r_tran)            :: answer, use_tol

    integer(kind=i_def), parameter :: nlayers = 1
    integer(kind=i_def), parameter :: ndf_w3 = 1
    integer(kind=i_def), parameter :: ndf_w2 = 4
    integer(kind=i_def), parameter :: ndf_wp = 1
    integer(kind=i_def), parameter :: stencil_size = 9
    integer(kind=i_def), parameter :: stencil_extent = ( stencil_size - 1_i_def ) / 2_i_def
    integer(kind=i_def), parameter :: undf_w2 = ndf_w2*nlayers
    integer(kind=i_def), parameter :: undf_w3 = ndf_w3*nlayers*stencil_size
    integer(kind=i_def), parameter :: undf_wp = ndf_wp*nlayers*stencil_size
    integer(kind=i_def), parameter :: order = 2

    integer(kind=i_def), dimension(ndf_w3)              :: map_w3
    integer(kind=i_def), dimension(ndf_w2)              :: map_w2
    integer(kind=i_def), dimension(ndf_wp)              :: map_wp
    integer(kind=i_def), dimension(ndf_w3,stencil_size) :: stencil_map

    real(kind=r_tran),   dimension(undf_w3) :: field_x
    real(kind=r_tran),   dimension(undf_w3) :: field_y
    real(kind=r_tran),   dimension(undf_w2) :: dep_pts
    real(kind=r_tran),   dimension(undf_w2) :: flux_high
    real(kind=r_tran),   dimension(undf_w2) :: flux_low
    real(kind=r_tran),   dimension(undf_w2) :: flux_int
    integer(kind=i_def), dimension(undf_wp) :: i_start
    integer(kind=i_def), dimension(undf_wp) :: i_end
    real(kind=r_tran),   dimension(undf_w3) :: detj

    integer(kind=i_def), parameter         :: stencil_size_p = 9
    real(kind=r_def), dimension(undf_wp)   :: panel_id
    logical(kind=l_def)                    :: edges_spt =.false.
    integer(kind=i_def), dimension(ndf_wp,stencil_size_p) :: stencil_map_p

    real(kind=r_tran)   :: dt
    integer(kind=i_def) :: monotone

    ! Set up maps
    stencil_map(1,:) = (/ 5, 4, 3, 2, 1, 6, 7, 8, 9 /)
    map_w2(:) = (/ 1, 2, 3, 4 /)
    map_w3(1) = 1
    map_wp(1) = 1
    panel_id(:) = 1.0_r_def

    ! Set no monotonicity
    monotone = horizontal_monotone_none

    ! Set up field x to have quadratic profile and field y to be constant
    field_x(:) = (/ 17.0_r_tran, 10.0_r_tran, 5.0_r_tran, &
                    2.0_r_tran,  1.0_r_tran,  2.0_r_tran, &
                    5.0_r_tran,  10.0_r_tran, 17.0_r_tran /)
    field_y(:) = (/ 1.0_r_tran, 1.0_r_tran, 1.0_r_tran, &
                    1.0_r_tran, 1.0_r_tran, 1.0_r_tran, &
                    1.0_r_tran, 1.0_r_tran, 1.0_r_tran /)

    ! Initialise flux to zero before each test
    flux_high(:) = 0.0_r_tran
    flux_low(:) = 0.0_r_tran
    flux_int(:) = 0.0_r_tran

    ! Volume factor
    detj(:) = 2.0_r_tran

    ! Test with integer departure distance on one panel
    dep_pts(:) = 1.0_r_tran
    dt = 1.0_r_tran
    i_start = -1_i_def
    i_end = -2_i_def
    call ffsl_flux_final_y_code( nlayers,        &
                                 flux_high,      &
                                 flux_low,       &
                                 flux_int,       &
                                 field_x,        &
                                 stencil_size,   &
                                 stencil_map,    &
                                 field_y,        &
                                 stencil_size,   &
                                 stencil_map,    &
                                 panel_id,       &
                                 stencil_size_p, &
                                 stencil_map_p,  &
                                 i_start,        &
                                 i_end,          &
                                 dep_pts,        &
                                 detj,           &
                                 stencil_size,   &
                                 stencil_map,    &
                                 order,          &
                                 monotone,       &
                                 stencil_extent, &
                                 dt,             &
                                 edges_spt,      &
                                 ndf_w2,         &
                                 undf_w2,        &
                                 map_w2,         &
                                 ndf_w3,         &
                                 undf_w3,        &
                                 map_w3,         &
                                 ndf_wp,         &
                                 undf_wp,        &
                                 map_wp )
    ! Get correct tolerance
    if ( r_tran == real64 ) then
      use_tol = tol
    else
      use_tol = 10.0_r_tran*spacing( maxval( flux_high(1:4) ) )
    end if
    answer = 0.0_r_tran
    @assertEqual(answer, flux_high(2), use_tol)
    answer = 4.0_r_tran
    @assertEqual(answer, flux_int(2), use_tol)
    answer = 0.0_r_tran
    @assertEqual(answer, flux_high(4), use_tol)
    answer = 2.0_r_tran
    @assertEqual(answer, flux_int(4), use_tol)

    ! Test with positive distance on one panel
    dep_pts(:) = 0.6_r_tran
    dt = 1.0_r_tran
    flux_high(:) = 0.0_r_tran
    flux_low(:) = 0.0_r_tran
    flux_int(:) = 0.0_r_tran
    i_start = -1_i_def
    i_end = -2_i_def
    call ffsl_flux_final_y_code( nlayers,        &
                                 flux_high,      &
                                 flux_low,       &
                                 flux_int,       &
                                 field_x,        &
                                 stencil_size,   &
                                 stencil_map,    &
                                 field_y,        &
                                 stencil_size,   &
                                 stencil_map,    &
                                 panel_id,       &
                                 stencil_size_p, &
                                 stencil_map_p,  &
                                 i_start,        &
                                 i_end,          &
                                 dep_pts,        &
                                 detj,           &
                                 stencil_size,   &
                                 stencil_map,    &
                                 order,          &
                                 monotone,       &
                                 stencil_extent, &
                                 dt,             &
                                 edges_spt,      &
                                 ndf_w2,         &
                                 undf_w2,        &
                                 map_w2,         &
                                 ndf_w3,         &
                                 undf_w3,        &
                                 map_w3,         &
                                 ndf_wp,         &
                                 undf_wp,        &
                                 map_wp )
    answer = 1.904_r_tran
    @assertEqual(answer, flux_high(2), use_tol)
    answer = 1.184_r_tran
    @assertEqual(answer, flux_high(4), use_tol)

    ! Test with positive distance over panel edge
    dep_pts(:) = 0.4_r_tran
    dt = 1.0_r_tran
    flux_high(:) = 0.0_r_tran
    flux_low(:) = 0.0_r_tran
    flux_int(:) = 0.0_r_tran
    i_start = 1_i_def
    i_end = 4_i_def
    call ffsl_flux_final_y_code( nlayers,        &
                                 flux_high,      &
                                 flux_low,       &
                                 flux_int,       &
                                 field_x,        &
                                 stencil_size,   &
                                 stencil_map,    &
                                 field_y,        &
                                 stencil_size,   &
                                 stencil_map,    &
                                 panel_id,       &
                                 stencil_size_p, &
                                 stencil_map_p,  &
                                 i_start,        &
                                 i_end,          &
                                 dep_pts,        &
                                 detj,           &
                                 stencil_size,   &
                                 stencil_map,    &
                                 order,          &
                                 monotone,       &
                                 stencil_extent, &
                                 dt,             &
                                 edges_spt,      &
                                 ndf_w2,         &
                                 undf_w2,        &
                                 map_w2,         &
                                 ndf_w3,         &
                                 undf_w3,        &
                                 map_w3,         &
                                 ndf_wp,         &
                                 undf_wp,        &
                                 map_wp )
    answer = 0.776_r_tran
    @assertEqual(answer, flux_high(2), use_tol)
    answer = 0.888_r_tran
    @assertEqual(answer, flux_high(4), use_tol)

    ! Test with negative distance over panel edge
    dep_pts(:) = -0.4_r_tran
    dt = 1.0_r_tran
    flux_high(:) = 0.0_r_tran
    flux_low(:) = 0.0_r_tran
    flux_int(:) = 0.0_r_tran
    i_start = 6_i_def
    i_end = 9_i_def
    call ffsl_flux_final_y_code( nlayers,        &
                                 flux_high,      &
                                 flux_low,       &
                                 flux_int,       &
                                 field_x,        &
                                 stencil_size,   &
                                 stencil_map,    &
                                 field_y,        &
                                 stencil_size,   &
                                 stencil_map,    &
                                 panel_id,       &
                                 stencil_size_p, &
                                 stencil_map_p,  &
                                 i_start,        &
                                 i_end,          &
                                 dep_pts,        &
                                 detj,           &
                                 stencil_size,   &
                                 stencil_map,    &
                                 order,          &
                                 monotone,       &
                                 stencil_extent, &
                                 dt,             &
                                 edges_spt,      &
                                 ndf_w2,         &
                                 undf_w2,        &
                                 map_w2,         &
                                 ndf_w3,         &
                                 undf_w3,        &
                                 map_w3,         &
                                 ndf_wp,         &
                                 undf_wp,        &
                                 map_wp )
    answer = -0.888_r_tran
    @assertEqual(answer, flux_high(2), use_tol)
    answer = -0.776_r_tran
    @assertEqual(answer, flux_high(4), use_tol)

  end subroutine test_all

end module ffsl_flux_final_y_kernel_mod_test
