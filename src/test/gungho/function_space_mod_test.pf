!-------------------------------------------------------------------------------
! (c) The copyright relating to this work is owned jointly by the Crown, 
! Met Office and NERC 2014. 
! However, it has been created with the help of the GungHo Consortium, 
! whose members are identified at https://puma.nerc.ac.uk/trac/GungHo/wiki
!-------------------------------------------------------------------------------
!
!-------------------------------------------------------------------------------
module function_space_mod_test
  implicit none 

contains

  @test
  subroutine test_func_space()
    use pFUnit_Mod
    use function_space_mod, only : function_space_type, W0, W1, W2, W3
    use constants_mod, only : r_def
    use mesh_mod, only : num_cells, w_unique_dofs, num_layers
    use gaussian_quadrature_mod, only : ngp_h, ngp_v
    use basis_function_mod,         only : &
              w0_basis, w1_basis, w2_basis, w3_basis, &
              w0_diff_basis, w1_diff_basis, w2_diff_basis, w3_diff_basis, &
              w0_nodal_coords, w1_nodal_coords, w2_nodal_coords, w3_nodal_coords
    use dofmap_mod,                 only : &
              w0_dofmap, w1_dofmap, w2_dofmap, w3_dofmap
    implicit none

    type(function_space_type) :: w0_func_space, w1_func_space, &
                                 w2_func_space, w3_func_space

    integer          :: num_dofs, num_unique_dofs
    integer          :: testncell, testundf, test_fs
    real(kind=r_def), pointer, dimension(:,:,:,:) :: test_basis
    integer          :: i,j
    integer, pointer :: testmap(:)
    real(kind=r_def) :: epsilon
    real(kind=r_def), pointer, dimension(:,:) :: test_nodes

    integer          :: test_w0_dofmap_result_1,&
                        test_w0_dofmap_result_2

    real(kind=r_def) :: test_w0_basis_result, &
                        test_w0_diff_basis_result

    real(kind=r_def) :: test_w0_nodal_coords_1, &
                        test_w0_nodal_coords_2, &
                        test_w0_nodal_coords_3

    integer          :: test_w1_dofmap_result_1,&
                        test_w1_dofmap_result_2

    real(kind=r_def) :: test_w1_basis_result, &
                        test_w1_diff_basis_result

    real(kind=r_def) :: test_w1_nodal_coords_1, &
                        test_w1_nodal_coords_2, &
                        test_w1_nodal_coords_3

    integer          :: test_w2_dofmap_result_1,&
                        test_w2_dofmap_result_2

    real(kind=r_def) :: test_w2_basis_result, &
                        test_w2_diff_basis_result

    real(kind=r_def) :: test_w2_nodal_coords_1, &
                        test_w2_nodal_coords_2, &
                        test_w2_nodal_coords_3

    integer          :: test_w3_dofmap_result_1,&
                        test_w3_dofmap_result_2

    real(kind=r_def) :: test_w3_basis_result, &
                        test_w3_diff_basis_result

    real(kind=r_def) :: test_w3_nodal_coords_1, &
                        test_w3_nodal_coords_2, &
                        test_w3_nodal_coords_3
    
    ! set some sizes ...
    num_cells = 35
    num_layers = 50
    num_dofs=4
    num_unique_dofs = 100
    do i=1,4
      w_unique_dofs(i,1)=num_unique_dofs
      w_unique_dofs(i,2)=num_dofs
    enddo

    if ( allocated( w0_basis ) ) then
      deallocate( w0_basis )
      deallocate( w0_diff_basis )
      deallocate( w0_nodal_coords )
      deallocate( w0_dofmap )
    end if
    if ( allocated( w1_basis ) ) then
      deallocate( w1_basis )
      deallocate( w1_diff_basis )
      deallocate( w1_nodal_coords )
      deallocate( w1_dofmap )
    end if
    if ( allocated( w2_basis ) ) then
      deallocate( w2_basis )
      deallocate( w2_diff_basis )
      deallocate( w2_nodal_coords )
      deallocate( w2_dofmap )
    end if
    if ( allocated( w3_basis ) ) then
      deallocate( w3_basis )
      deallocate( w3_diff_basis )
      deallocate( w3_nodal_coords )
      deallocate( w3_dofmap )
    end if

    allocate(w0_basis(1,w_unique_dofs(1,2),ngp_h,ngp_v))
    allocate(w1_basis(3,w_unique_dofs(2,2),ngp_h,ngp_v))
    allocate(w2_basis(3,w_unique_dofs(3,2),ngp_h,ngp_v))
    allocate(w3_basis(1,w_unique_dofs(4,2),ngp_h,ngp_v))
    allocate(w0_diff_basis(3,w_unique_dofs(1,2),ngp_h,ngp_v))
    allocate(w1_diff_basis(3,w_unique_dofs(2,2),ngp_h,ngp_v))
    allocate(w2_diff_basis(1,w_unique_dofs(3,2),ngp_h,ngp_v))
    allocate(w3_diff_basis(1,w_unique_dofs(4,2),ngp_h,ngp_v))
    allocate(w0_nodal_coords(3,w_unique_dofs(1,2)))
    allocate(w1_nodal_coords(3,w_unique_dofs(2,2)))
    allocate(w2_nodal_coords(3,w_unique_dofs(3,2)))
    allocate(w3_nodal_coords(3,w_unique_dofs(4,2)))
    allocate( w0_dofmap(w_unique_dofs(1,2),0:num_cells) )
    allocate( w1_dofmap(w_unique_dofs(2,2),0:num_cells) )
    allocate( w2_dofmap(w_unique_dofs(3,2),0:num_cells) )
    allocate( w3_dofmap(w_unique_dofs(4,2),0:num_cells) )

    w0_basis=sqrt(2.0_r_def)
    w1_basis=sqrt(2.0_r_def)
    w2_basis=sqrt(2.0_r_def)
    w3_basis=sqrt(2.0_r_def)
    w0_diff_basis=atan(4.0_r_def)
    w1_diff_basis=atan(4.0_r_def)
    w2_diff_basis=atan(4.0_r_def)
    w3_diff_basis=atan(4.0_r_def)
    w0_nodal_coords(1,:)=0.152689632_r_def
    w0_nodal_coords(2,:)=0.562554751_r_def
    w0_nodal_coords(3,:)=-0.8234_r_def
    w1_nodal_coords(1,:)=0.152689632_r_def
    w1_nodal_coords(2,:)=0.562554751_r_def
    w1_nodal_coords(3,:)=-0.8234_r_def
    w2_nodal_coords(1,:)=0.152689632_r_def
    w2_nodal_coords(2,:)=0.562554751_r_def
    w2_nodal_coords(3,:)=-0.8234_r_def
    w3_nodal_coords(1,:)=0.152689632_r_def
    w3_nodal_coords(2,:)=0.562554751_r_def
    w3_nodal_coords(3,:)=-0.8234_r_def
    do i=0,num_cells
       w0_dofmap(:,i) = i+64
       w1_dofmap(:,i) = i+64
       w2_dofmap(:,i) = i+64
       w3_dofmap(:,i) = i+64
    end do

! Grab some of the contents of the module data for later testing
! before it is moved into the function space 
    test_w0_dofmap_result_1=w0_dofmap(1,0)
    test_w0_dofmap_result_2=w0_dofmap(1,num_cells-2)

    test_w0_basis_result=w0_basis(1,1,1,1)
    test_w0_diff_basis_result=w0_diff_basis(1,1,1,1)

    test_w0_nodal_coords_1=w0_nodal_coords(1,1)
    test_w0_nodal_coords_2=w0_nodal_coords(2,1)
    test_w0_nodal_coords_3=w0_nodal_coords(3,1)

    test_w1_dofmap_result_1=w1_dofmap(1,0)
    test_w1_dofmap_result_2=w1_dofmap(1,num_cells-2)

    test_w1_basis_result=w1_basis(1,1,1,1)
    test_w1_diff_basis_result=w1_diff_basis(1,1,1,1)

    test_w1_nodal_coords_1=w1_nodal_coords(1,1)
    test_w1_nodal_coords_2=w1_nodal_coords(2,1)
    test_w1_nodal_coords_3=w1_nodal_coords(3,1)

    test_w2_dofmap_result_1=w2_dofmap(1,0)
    test_w2_dofmap_result_2=w2_dofmap(1,num_cells-2)

    test_w2_basis_result=w2_basis(1,1,1,1)
    test_w2_diff_basis_result=w2_diff_basis(1,1,1,1)

    test_w2_nodal_coords_1=w2_nodal_coords(1,1)
    test_w2_nodal_coords_2=w2_nodal_coords(2,1)
    test_w2_nodal_coords_3=w2_nodal_coords(3,1)

    test_w3_dofmap_result_1=w3_dofmap(1,0)
    test_w3_dofmap_result_2=w3_dofmap(1,num_cells-2)

    test_w3_basis_result=w3_basis(1,1,1,1)
    test_w3_diff_basis_result=w3_diff_basis(1,1,1,1)

    test_w3_nodal_coords_1=w3_nodal_coords(1,1)
    test_w3_nodal_coords_2=w3_nodal_coords(2,1)
    test_w3_nodal_coords_3=w3_nodal_coords(3,1)

!w0
    w0_func_space = w0_func_space%get_instance(W0)

    ! test the procedures of the type
    testncell = w0_func_space%get_ncell()
    @assertEqual( num_cells, testncell )

    testundf = w0_func_space%get_undf()
    @assertEqual( num_unique_dofs, testundf )

    testmap => w0_func_space%get_cell_dofmap(0)
    @assertEqual( test_w0_dofmap_result_1, testmap(1) )

    testmap => w0_func_space%get_cell_dofmap(num_cells-2)    
    @assertEqual( test_w0_dofmap_result_2, testmap(1) )

    epsilon = 1.0e-14_r_def

    test_basis => w0_func_space%get_basis( )
    @assertEqual( test_w0_basis_result , test_basis(1,1,1,1), epsilon )

    test_basis => w0_func_space%get_diff_basis()
    @assertEqual( test_w0_diff_basis_result, test_basis(1,1,1,1), epsilon )

    test_nodes => w0_func_space%get_nodes( )
    @assertEqual( test_w0_nodal_coords_1, test_nodes(1,1), epsilon )
    @assertEqual( test_w0_nodal_coords_2, test_nodes(2,1), epsilon )
    @assertEqual( test_w0_nodal_coords_3, test_nodes(3,1), epsilon )

    test_fs = w0_func_space%which()
    @assertEqual(test_fs,W0)

!w1
    w1_func_space = w1_func_space%get_instance(W1)

    ! test the procedures of the type
    testncell = w1_func_space%get_ncell()
    @assertEqual( num_cells, testncell )

    testundf = w1_func_space%get_undf()
    @assertEqual( num_unique_dofs, testundf )

    testmap => w1_func_space%get_cell_dofmap(0)
    @assertEqual( test_w1_dofmap_result_1, testmap(1) )

    testmap => w1_func_space%get_cell_dofmap(num_cells-2)    
    @assertEqual( test_w1_dofmap_result_2, testmap(1) )

    epsilon = 1.0e-14_r_def

    test_basis => w1_func_space%get_basis( )
    @assertEqual( test_w1_basis_result, test_basis(1,1,1,1), epsilon )

    test_basis => w1_func_space%get_diff_basis()
    @assertEqual( test_w1_diff_basis_result, test_basis(1,1,1,1), epsilon )

    test_nodes => w1_func_space%get_nodes( )
    @assertEqual( test_w1_nodal_coords_1, test_nodes(1,1), epsilon )
    @assertEqual( test_w1_nodal_coords_2, test_nodes(2,1), epsilon )
    @assertEqual( test_w1_nodal_coords_3, test_nodes(3,1), epsilon )

    test_fs = w1_func_space%which()
    @assertEqual(test_fs,W1)

!w2
    w2_func_space = w2_func_space%get_instance(W2)

    ! test the procedures of the type
    testncell = w2_func_space%get_ncell()
    @assertEqual( num_cells, testncell )

    testundf = w2_func_space%get_undf()
    @assertEqual( num_unique_dofs, testundf )

    testmap => w2_func_space%get_cell_dofmap(0)
    @assertEqual( test_w2_dofmap_result_1, testmap(1) )

    testmap => w2_func_space%get_cell_dofmap(num_cells-2)    
    @assertEqual( test_w2_dofmap_result_2, testmap(1) )

    epsilon = 1.0e-14_r_def

    test_basis => w2_func_space%get_basis( )
    @assertEqual( test_w2_basis_result, test_basis(1,1,1,1), epsilon )

    test_basis => w2_func_space%get_diff_basis()
    @assertEqual( test_w2_diff_basis_result, test_basis(1,1,1,1), epsilon )

    test_nodes => w2_func_space%get_nodes( )
    @assertEqual( test_w2_nodal_coords_1, test_nodes(1,1), epsilon )
    @assertEqual( test_w2_nodal_coords_2, test_nodes(2,1), epsilon )
    @assertEqual( test_w2_nodal_coords_3, test_nodes(3,1), epsilon )

    test_fs = w2_func_space%which()
    @assertEqual(test_fs,W2)

!w3
    w3_func_space = w3_func_space%get_instance(W3)

    ! test the procedures of the type
    testncell = w3_func_space%get_ncell()
    @assertEqual( num_cells, testncell )

    testundf = w3_func_space%get_undf()
    @assertEqual( num_unique_dofs, testundf )

    testmap => w3_func_space%get_cell_dofmap(0)
    @assertEqual( test_w3_dofmap_result_1, testmap(1) )

    testmap => w3_func_space%get_cell_dofmap(num_cells-2)    
    @assertEqual( test_w3_dofmap_result_2, testmap(1) )

    epsilon = 1.0e-14_r_def

    test_basis => w3_func_space%get_basis( )
    @assertEqual( test_w3_basis_result, test_basis(1,1,1,1), epsilon )

    test_basis => w3_func_space%get_diff_basis()
    @assertEqual( test_w3_diff_basis_result, test_basis(1,1,1,1), epsilon )

    test_nodes => w3_func_space%get_nodes( )
    @assertEqual( test_w3_nodal_coords_1, test_nodes(1,1), epsilon )
    @assertEqual( test_w3_nodal_coords_2, test_nodes(2,1), epsilon )
    @assertEqual( test_w3_nodal_coords_3, test_nodes(3,1), epsilon )

    test_fs = w3_func_space%which()
    @assertEqual(test_fs,W3)


  end subroutine test_func_space

end module function_space_mod_test
