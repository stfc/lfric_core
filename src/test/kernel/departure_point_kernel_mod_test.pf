!-----------------------------------------------------------------------------
! (c) The copyright relating to this work is owned jointly by the Crown, 
! Met Office and NERC 2014. 
! However, it has been created with the help of the GungHo Consortium, 
! whose members are identified at https://puma.nerc.ac.uk/trac/GungHo/wiki
!-----------------------------------------------------------------------------

module departure_point_kernel_mod_test

  use pFUnit_Mod
  use constants_mod,      only : i_def, r_def
  use mesh_mod,           only : mesh_type

  implicit none

  private
  public :: developed_departure_point_test_type , test_all

  @TestCase
  type, extends(TestCase) :: developed_departure_point_test_type
    private
    type(mesh_type)          :: mesh
  contains
    procedure setUp
    procedure test_all
  end type developed_departure_point_test_type

  real(r_def), parameter :: dt  = 10.0_r_def
  real(r_def), parameter :: alpha   = 0.5_r_def
  integer(i_def), parameter :: inner_iterations = 0
  integer(i_def), parameter :: outer_iterations = 0
  integer(i_def), parameter :: spinup_period = 0
  logical, parameter :: spinup_winds  = .false.
  logical, parameter :: spinup_alpha  = .false.

contains


  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  subroutine setUp( this )

    use feign_config_mod,           only : feign_timestepping_config
    use timestepping_config_mod,   only : timestepping_method_semi_implicit, &
                                          timestepping_runge_kutta_method_ssp3

    implicit none

    class(developed_departure_point_test_type), intent(inout) :: this

    call feign_timestepping_config( timestepping_method_semi_implicit,   &
                                    dt,                                  &
                                    alpha,                               &
                                    outer_iterations,                    &
                                    inner_iterations,                    &
                                    timestepping_runge_kutta_method_ssp3,&
				    spinup_period,                       &
				    spinup_alpha,                        &
				    spinup_winds                         &
				    )


  end subroutine setUp


  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  @test
  subroutine test_all( this )

    use calc_departure_point_kernel_mod, only : calc_departure_point_code
    use flux_direction_mod, only : x_direction
    use biperiodic_deppt_config_mod, only: biperiodic_deppt_method_euler, biperiodic_deppt_method_trapezoidal

    implicit none

    class(developed_departure_point_test_type), intent(inout) :: this

    real(r_def), parameter :: tol    = 1.0e-6_r_def

    real(kind=r_def),allocatable :: u_field(:),  dep_pts(:)

    integer          :: nlayers
    integer          :: ndf_w0, ndf_w2, ndf_w3
    integer          :: undf_w0, undf_w2, undf_w3

    integer :: departure_pt_stencil_length
    integer, allocatable :: stencil_map_W2(:,:)

    nlayers = 1
    undf_w2 = 11
    ndf_w2 = 4
    ndf_w3 = 1
    departure_pt_stencil_length = 9

    allocate(u_field(1:undf_w2))
    allocate(dep_pts(1:undf_w2))
    allocate(stencil_map_W2(1:ndf_w2,1:departure_pt_stencil_length))

    u_field(:) = 0.10_r_def

    stencil_map_W2(1,1:departure_pt_stencil_length) = (/ 1,2,3,4,5,6,7,8,9 /)
    stencil_map_W2(2,1:departure_pt_stencil_length) = (/ 1,2,3,4,5,6,7,8,9 /)
    stencil_map_W2(3,1:departure_pt_stencil_length) = (/ 1,2,3,4,5,6,7,8,9 /)
    stencil_map_W2(4,1:departure_pt_stencil_length) = (/ 1,2,3,4,5,6,7,8,9 /)

    dep_pts(:) = 0.0_r_def

    call calc_departure_point_code( nlayers,                       &
                                    dep_pts,                       &
                                    departure_pt_stencil_length,   &
                                    undf_w2,                       &
                                    ndf_w2,                        &
                                    stencil_map_W2,                &
                                    u_field,                       &
                                    u_field,                       &
                                    x_direction,                   &
                                    biperiodic_deppt_method_euler )
    @assertEqual(1.0_r_def, dep_pts(1), tol)

    ! Rearranged so that it matches the stencil ordering in 1D
    u_field(:) = (/ 0.15_r_def,0.14_r_def,0.16_r_def,0.13_r_def,0.17_r_def,   &
                    0.12_r_def,0.17_r_def,0.11_r_def,0.19_r_def,0.10_r_def,   &
                    0.20_r_def /)

    dep_pts(:) = 0.0_r_def
    call calc_departure_point_code( nlayers,                       &
                                    dep_pts,                       &
                                    departure_pt_stencil_length,   &
                                    undf_w2,                       &
                                    ndf_w2,                        &
                                    stencil_map_W2,                &
                                    u_field,                       &
                                    u_field,                       &
                                    x_direction,                   &
                                    biperiodic_deppt_method_euler )
    @assertEqual(1.5_r_def, dep_pts(1), tol)


  end subroutine test_all


end module departure_point_kernel_mod_test
