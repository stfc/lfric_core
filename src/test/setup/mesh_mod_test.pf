!-----------------------------------------------------------------------------
! (c) The copyright relating to this work is owned jointly by the Crown,
! Met Office and NERC 2014.
! However, it has been created with the help of the GungHo Consortium,
! whose members are identified at https://puma.nerc.ac.uk/trac/GungHo/wiki
!-----------------------------------------------------------------------------

!> @brief pFunut tests for the mesh module
!>
module mesh_mod_test

  use constants_mod,        only: r_def, i_def, PI
  use coord_transform_mod,  only: llr2xyz
  use extrusion_config_mod, only: extrusion_method_uniform
  use global_mesh_mod,      only: global_mesh_type
  use partition_mod,        only: partition_type
  use mesh_mod,             only: mesh_type
  use mesh_constructor_helper_functions_mod, &
                                  only: domain_size_type
  use pFUnit_Mod

  implicit none

  private
  public :: mesh_test_type,  &
            test_get_scalar, test_get_integer, test_get_boolean, &
            test_get_1d_array, test_get_2d_array, test_get_3d_array, &
            test_extrude_uniform, test_extrude_quadratic, test_extrude_geometric, &
            test_extrude_dcmip


  @testCase
  type, extends( TestCase ) :: mesh_test_type
    private
    type(global_mesh_type) :: global_mesh
    type(partition_type)   :: partition
  contains
    procedure :: setUp
    procedure :: tearDown
    procedure :: test_get_scalar
    procedure :: test_get_1d_array
    procedure :: test_get_2d_array
    procedure :: test_get_3d_array
    procedure :: test_extrude_uniform
    procedure :: test_extrude_quadratic
    procedure :: test_extrude_geometric
    procedure :: test_extrude_dcmip
  end type mesh_test_type

  integer(i_def), parameter :: nlayers    = 5_i_def
  real(r_def),    parameter :: domain_top = 10000.0_r_def

  real(r_def), parameter :: gravity = 10.0_r_def
  real(r_def), parameter :: radius  = 6371229.0_r_def
  real(r_def), parameter :: omega   = 8.0E-5_r_def
  real(r_def), parameter :: p_zero  = 100000.0_r_def
  real(r_def), parameter :: rd      = 300.0_r_def
  real(r_def), parameter :: cp      = 1000.0_r_def
  real(r_def), parameter :: scaling = 125.0_r_def

contains

  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  subroutine setUp( this )

    use base_mesh_config_mod,      only : base_mesh_geometry_spherical, &
                                          base_mesh_partitioner_cubedsphere
    use finite_element_config_mod, only : finite_element_shape_quadrilateral
    use feign_config_mod,          only : feign_base_mesh_config, &
                                          feign_extrusion_config, &
                                          feign_planet_config
    use reference_element_mod,     only : reference_cube, reference_element

    implicit none

    class( mesh_test_type ), intent( inout ) :: this

    call feign_base_mesh_config( 'foo',                             &
                                 base_mesh_geometry_spherical,      &
                                 base_mesh_partitioner_cubedsphere, &
                                 .false., 0.0_r_def )
    call feign_extrusion_config( extrusion_method_uniform, domain_top, nlayers )
    call feign_planet_config( gravity, radius, omega, rd, cp, p_zero, scaling )

    reference_element = finite_element_shape_quadrilateral
    call reference_cube()

    this%global_mesh = global_mesh_type()
    this%partition   = partition_type()

  end subroutine setUp

  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  subroutine tearDown( this )

    use reference_element_mod, only : deallocate_reference

    implicit none

    class( mesh_test_type ), intent( inout ) :: this

    call deallocate_reference()

  end subroutine tearDown

  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  @test
  subroutine test_get_scalar( this )

    implicit none

    class( mesh_test_type ), intent( inout ) :: this

    type (mesh_type) :: mesh_1
    type (domain_size_type) :: domain

    integer(i_def) :: test_integer
    mesh_1 = mesh_type( this%global_mesh, &
                        this%partition,   &
                        nlayers,     &
                        domain_top,  &
                        extrusion_method_uniform )

    !-------------------------------------------------------------------
    ! Test get_nlayers
    test_integer = mesh_1%get_nlayers()
    @assertEqual ( 5, test_integer )

    !-------------------------------------------------------------------
    ! Test get_ncells_2d
    test_integer = mesh_1%get_ncells_2d()
    @assertEqual ( 9, test_integer )

    !-------------------------------------------------------------------
    ! Test get_ncells_2d_with_ghost
    test_integer = mesh_1%get_ncells_2d_with_ghost()
    @assertEqual ( 9, test_integer )

    !-------------------------------------------------------------------
    ! Test get_nverts_2d
    test_integer = mesh_1%get_nverts_2d()
    @assertEqual ( 16, test_integer )

    !-------------------------------------------------------------------
    ! Test get_nedges_2d
    test_integer = mesh_1%get_nedges_2d()
    @assertEqual ( 24, test_integer )

    !-------------------------------------------------------------------
    ! Test get_ncells
    test_integer = mesh_1%get_ncells()
    @assertEqual ( 45, test_integer )

    !-------------------------------------------------------------------
    ! Test get_nverts
    test_integer = mesh_1%get_nverts()
    @assertEqual ( 96, test_integer )

    !-------------------------------------------------------------------
    ! Test get_nedges
    test_integer = mesh_1%get_nedges()
    @assertEqual ( 224, test_integer )

    !-------------------------------------------------------------------
    ! Test get_nfaces
    test_integer = mesh_1%get_nfaces()
    @assertEqual ( 174, test_integer )

    !-------------------------------------------------------------------
    ! Test get_nverts_per_cell
    test_integer = mesh_1%get_nverts_per_cell()
    @assertEqual ( 8, test_integer )

    !-------------------------------------------------------------------
    ! Test get_nedges_per_cell
    test_integer = mesh_1%get_nedges_per_cell()
    @assertEqual ( 12, test_integer )

    !-------------------------------------------------------------------
    ! Test get_nfaces_per_cell
    test_integer = mesh_1%get_nfaces_per_cell()
    @assertEqual ( 6, test_integer )

    !-------------------------------------------------------------------
    ! Test get_cell_gid
    test_integer = mesh_1%get_cell_gid( 2 )
    @assertEqual ( 2, test_integer )

    !-------------------------------------------------------------------
    ! Test get_cell_lid
    test_integer = mesh_1%get_cell_lid( 3 )
    @assertEqual ( 3, test_integer )

    !-------------------------------------------------------------------
    ! Test get_cell_next()
    test_integer = mesh_1%get_cell_next( 6, 23 )
    @assertEqual ( 32, test_integer )

    test_integer = mesh_1%get_cell_next( 3, 9 )
    @assertEqual ( 0, test_integer )

    test_integer = mesh_1%get_cell_next( 3, 18 )
    @assertEqual ( 0, test_integer )

    !-------------------------------------------------------------------
    ! Test get_face_on_cell()
    test_integer = mesh_1%get_face_on_cell( 3, 9 )
    @assertEqual ( 39, test_integer )

    !-------------------------------------------------------------------
    ! Test get_edge_on_cell()
    test_integer = mesh_1%get_edge_on_cell( 1, 5 )
    @assertEqual ( 31, test_integer )

    test_integer = mesh_1%get_edge_on_cell( 5, 5 )
    @assertEqual ( 11, test_integer )

    test_integer = mesh_1%get_edge_on_cell( 9, 5 )
    @assertEqual ( 32, test_integer )

    test_integer = mesh_1%get_edge_on_cell( 12, 5 )
    @assertEqual ( 40, test_integer )

    test_integer = mesh_1%get_edge_on_cell( 6, 9 )
    @assertEqual ( 46, test_integer )

  end subroutine test_get_scalar

  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  @test
  subroutine test_get_1d_array( this )

    implicit none

    class( mesh_test_type ), intent( inout ) :: this

    type (mesh_type) :: mesh_1

    real(r_def) :: test_real_array1(3)
    real(r_def) :: test_real_array2(3)

    mesh_1 = mesh_type( this%global_mesh, &
                        this%partition,   &
                        nlayers,     &
                        domain_top,  &
                        extrusion_method_uniform )

    !-------------------------------------------------------------------
    ! Test get_vert_coords
    ! Note: Returns coords in cartesian coords [x,y,z]
    ! Test multiple vertices
    test_real_array2(:) = [  14879.4488_r_def, -23173.3685_r_def, -42889.6347_r_def ]
    call mesh_1%get_vert_coords(3, test_real_array1)
    @assertEqual ( test_real_array2, test_real_array1, 1.0e-2_r_def )

    test_real_array2(:) = [ -11460.3167_r_def, -25041.2489_r_def, -42889.6347_r_def ]
    call mesh_1%get_vert_coords(4, test_real_array1)
    @assertEqual ( test_real_array2, test_real_array1, 1.0e-2_r_def )

    test_real_array2(:) = [   8826.8632_r_def, -19287.0480_r_def, -46346.7371_r_def ]
    call mesh_1%get_vert_coords(7, test_real_array1)
    @assertEqual ( test_real_array2, test_real_array1, 1.0e-2_r_def )

    test_real_array2(:) = [ -11460.3167_r_def, -25041.2489_r_def,  42889.6347_r_def ]
    call mesh_1%get_vert_coords(10, test_real_array1)
    @assertEqual ( test_real_array2, test_real_array1, 1.0e-2_r_def )

    test_real_array2(:) = [   8826.8632_r_def, -19287.0480_r_def,  46346.7371_r_def ]
    call mesh_1%get_vert_coords(16, test_real_array1)
    @assertEqual ( test_real_array2, test_real_array1, 1.0e-2_r_def )

    test_real_array2(:) = [   9173.2196_r_def,  20043.8505_r_def, -48165.3319_r_def ]
    call mesh_1%get_vert_coords(17, test_real_array1)
    @assertEqual ( test_real_array2, test_real_array1, 1.0e-2_r_def )

    test_real_array2(:) = [  15463.3020_r_def,  24082.6660_r_def, -44572.5767_r_def ]
    call mesh_1%get_vert_coords(22, test_real_array1)
    @assertEqual ( test_real_array2, test_real_array1, 1.0e-2_r_def )

    test_real_array2(:) = [ -11910.0069_r_def,  26023.8399_r_def, -44572.5767_r_def ]
    call mesh_1%get_vert_coords(24, test_real_array1)
    @assertEqual ( test_real_array2, test_real_array1, 1.0e-2_r_def )

  end subroutine test_get_1d_array

  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  @test
  subroutine test_get_2d_array( this )

    implicit none

    class( mesh_test_type ), intent( inout ) :: this

    type (mesh_type) :: mesh_1

    real(r_def) :: test_real_array1_2d(3,8)
    real(r_def) :: test_real_array2_2d(3,8)
    mesh_1 = mesh_type( this%global_mesh, &
                        this%partition,   &
                        nlayers,     &
                        domain_top,  &
                        extrusion_method_uniform )

    !-------------------------------------------------------------------
    ! Test get_cell_coords
    ! Note: Returns coords in cartesian coords [x,y,z]
    ! Test a couple of cell ids
    test_real_array2_2d(:,1) = [   9865.9324_r_def,  21557.4555_r_def, -51802.5216_r_def ]
    test_real_array2_2d(:,2) = [ -12809.3873_r_def,  19949.4387_r_def, -51802.5216_r_def ]
    test_real_array2_2d(:,3) = [  16631.0083_r_def, -25901.2608_r_def, -47938.4606_r_def ]
    test_real_array2_2d(:,4) = [ -12809.3873_r_def, -27989.0219_r_def, -47938.4606_r_def ]
    test_real_array2_2d(:,5) = [  10212.2887_r_def,  22314.2580_r_def, -53621.1165_r_def ]
    test_real_array2_2d(:,6) = [ -13259.0775_r_def,  20649.7897_r_def, -53621.1165_r_def ]
    test_real_array2_2d(:,7) = [  17214.8615_r_def, -26810.5582_r_def, -49621.4026_r_def ]
    test_real_array2_2d(:,8) = [ -13259.0775_r_def, -28971.6129_r_def ,-49621.4026_r_def ]

    call mesh_1%get_cell_coords(28, test_real_array1_2d)
    @assertEqual ( test_real_array2_2d, test_real_array1_2d, 1.0e-2_r_def )


    test_real_array2_2d(:,1) = [  16047.1552_r_def, -24991.9634_r_def, -46255.5187_r_def ]
    test_real_array2_2d(:,2) = [  16047.1552_r_def,  24991.9634_r_def, -46255.5187_r_def ]
    test_real_array2_2d(:,3) = [  16047.1552_r_def,  24991.9634_r_def,  46255.5187_r_def ]
    test_real_array2_2d(:,4) = [  16047.1552_r_def, -24991.9634_r_def,  46255.5187_r_def ]
    test_real_array2_2d(:,5) = [  16631.0083_r_def, -25901.2608_r_def, -47938.4606_r_def ]
    test_real_array2_2d(:,6) = [  16631.0083_r_def,  25901.2608_r_def, -47938.4606_r_def ]
    test_real_array2_2d(:,7) = [  16631.0083_r_def,  25901.2608_r_def,  47938.4606_r_def ]
    test_real_array2_2d(:,8) = [  16631.0083_r_def, -25901.2608_r_def , 47938.4606_r_def ]

    call mesh_1%get_cell_coords(23, test_real_array1_2d)
    @assertEqual ( test_real_array2_2d, test_real_array1_2d, 1.0e-2_r_def )

  end subroutine test_get_2d_array

  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  @test
  subroutine test_get_3d_array( this )

    implicit none

    class( mesh_test_type ), intent( inout ) :: this

    type (mesh_type) :: mesh_1

    real(r_def) :: test_real_array1_3d(3,8,5)
    real(r_def) :: test_real_array2_3d(3,8,5)
    mesh_1 = mesh_type( this%global_mesh, &
                        this%partition,   &
                        nlayers,          &
                        domain_top,       &
                        extrusion_method_uniform )

    !-------------------------------------------------------------------
    ! Test get_column_coords
    ! Note: Returns coords in cartesian coords [x,y,z]
    ! Test two cells in the same column, they should return the same
    ! column of coords
    test_real_array2_3d(:,1,1) = [ -11460.3167_r_def, -25041.2489_r_def,  42889.6347_r_def ]
    test_real_array2_3d(:,2,1) = [  14879.4488_r_def, -23173.3685_r_def,  42889.6347_r_def ]
    test_real_array2_3d(:,3,1) = [ -11460.3167_r_def,  17848.3858_r_def,  46346.7371_r_def ]
    test_real_array2_3d(:,4,1) = [   8826.8632_r_def,  19287.0480_r_def,  46346.7371_r_def ]
    test_real_array2_3d(:,5,1) = [ -11910.0069_r_def, -26023.8399_r_def,  44572.5767_r_def ]
    test_real_array2_3d(:,6,1) = [  15463.3020_r_def, -24082.6660_r_def,  44572.5767_r_def ]
    test_real_array2_3d(:,7,1) = [ -11910.0069_r_def,  18548.7368_r_def,  48165.3319_r_def ]
    test_real_array2_3d(:,8,1) = [   9173.2196_r_def,  20043.8505_r_def,  48165.3319_r_def ]

    test_real_array2_3d(:,1,2) = [ -11910.0069_r_def, -26023.8399_r_def,  44572.5767_r_def ]
    test_real_array2_3d(:,2,2) = [  15463.3020_r_def, -24082.6660_r_def,  44572.5767_r_def ]
    test_real_array2_3d(:,3,2) = [ -11910.0069_r_def,  18548.7368_r_def,  48165.3319_r_def ]
    test_real_array2_3d(:,4,2) = [   9173.2196_r_def,  20043.8505_r_def,  48165.3319_r_def ]
    test_real_array2_3d(:,5,2) = [ -12359.6971_r_def, -27006.4309_r_def,  46255.5187_r_def ]
    test_real_array2_3d(:,6,2) = [  16047.1552_r_def, -24991.9634_r_def,  46255.5187_r_def ]
    test_real_array2_3d(:,7,2) = [ -12359.6971_r_def,  19249.0878_r_def,  49983.9268_r_def ]
    test_real_array2_3d(:,8,2) = [   9519.5760_r_def,  20800.6530_r_def,  49983.9268_r_def ]

    test_real_array2_3d(:,1,3) = [ -12359.6971_r_def, -27006.4309_r_def,  46255.5187_r_def ]
    test_real_array2_3d(:,2,3) = [  16047.1552_r_def, -24991.9634_r_def,  46255.5187_r_def ]
    test_real_array2_3d(:,3,3) = [ -12359.6971_r_def,  19249.0878_r_def,  49983.9268_r_def ]
    test_real_array2_3d(:,4,3) = [   9519.5760_r_def,  20800.6530_r_def,  49983.9268_r_def ]
    test_real_array2_3d(:,5,3) = [ -12809.3873_r_def, -27989.0219_r_def,  47938.4606_r_def ]
    test_real_array2_3d(:,6,3) = [  16631.0083_r_def, -25901.2608_r_def,  47938.4606_r_def ]
    test_real_array2_3d(:,7,3) = [ -12809.3873_r_def,  19949.4387_r_def,  51802.5216_r_def ]
    test_real_array2_3d(:,8,3) = [   9865.9324_r_def,  21557.4555_r_def,  51802.5216_r_def ]

    test_real_array2_3d(:,1,4) = [ -12809.3873_r_def, -27989.0219_r_def,  47938.4606_r_def ]
    test_real_array2_3d(:,2,4) = [  16631.0083_r_def, -25901.2608_r_def,  47938.4606_r_def ]
    test_real_array2_3d(:,3,4) = [ -12809.3873_r_def,  19949.4387_r_def,  51802.5216_r_def ]
    test_real_array2_3d(:,4,4) = [   9865.9324_r_def,  21557.4555_r_def,  51802.5216_r_def ]
    test_real_array2_3d(:,5,4) = [ -13259.0775_r_def, -28971.6129_r_def,  49621.4026_r_def ]
    test_real_array2_3d(:,6,4) = [  17214.8615_r_def, -26810.5582_r_def,  49621.4026_r_def ]
    test_real_array2_3d(:,7,4) = [ -13259.0775_r_def,  20649.7897_r_def,  53621.1165_r_def ]
    test_real_array2_3d(:,8,4) = [  10212.2887_r_def,  22314.2580_r_def,  53621.1165_r_def ]

    test_real_array2_3d(:,1,5) = [ -13259.0775_r_def, -28971.6129_r_def,  49621.4026_r_def ]
    test_real_array2_3d(:,2,5) = [  17214.8615_r_def, -26810.5582_r_def,  49621.4026_r_def ]
    test_real_array2_3d(:,3,5) = [ -13259.0775_r_def,  20649.7897_r_def,  53621.1165_r_def ]
    test_real_array2_3d(:,4,5) = [  10212.2887_r_def,  22314.2580_r_def,  53621.1165_r_def ]
    test_real_array2_3d(:,5,5) = [ -13708.7677_r_def, -29954.2039_r_def,  51304.3446_r_def ]
    test_real_array2_3d(:,6,5) = [  17798.7146_r_def, -27719.8557_r_def,  51304.3446_r_def ]
    test_real_array2_3d(:,7,5) = [ -13708.7677_r_def,  21350.1407_r_def,  55439.7114_r_def ]
    test_real_array2_3d(:,8,5) = [  10558.6451_r_def,  23071.0605_r_def,  55439.7114_r_def ]

    call mesh_1%get_column_coords(7, test_real_array1_3d)
    @assertEqual ( test_real_array2_3d, test_real_array1_3d, 1.0e-2_r_def )

    call mesh_1%get_column_coords(43, test_real_array1_3d)
    @assertEqual ( test_real_array2_3d, test_real_array1_3d, 1.0e-2_r_def )

  end subroutine test_get_3d_array

  @test 
  subroutine test_extrude_uniform(this)
    implicit none
    class(mesh_test_type), intent(inout) :: this

    real(r_def), parameter :: dz   = 2000.0_r_def
    type (mesh_type) :: mesh_1

    real(r_def) :: dz_test(nlayers)
    real(r_def) :: test_real

    mesh_1 = mesh_type( this%global_mesh, &
                        this%partition,   &
                        nlayers,          &
                        domain_top,       &
                        extrusion_method_uniform )

    dz_test = 0.0_r_def
    call mesh_1%get_dz(dz_test)
    test_real = dz_test(1)
    @assertEqual ( test_real, dz, 1.0e-2_r_def )

  end subroutine test_extrude_uniform

  @test 
  subroutine test_extrude_quadratic(this)
    use extrusion_config_mod, only: extrusion_method_quadratic
    implicit none
    class(mesh_test_type), intent(inout) :: this

    real(r_def), parameter :: dz   = 400.0_r_def
    type (mesh_type) :: mesh_1

    real(r_def) :: dz_test(nlayers)
    real(r_def) :: test_real

    mesh_1 = mesh_type( this%global_mesh, &
                        this%partition,   &
                        nlayers,          &
                        domain_top,       &
                        extrusion_method_quadratic)

    dz_test = 0.0_r_def
    call mesh_1%get_dz(dz_test)
    test_real = dz_test(1)
    @assertEqual ( test_real, dz, 1.0e-2_r_def )

  end subroutine test_extrude_quadratic

 @test 
  subroutine test_extrude_geometric(this)
    use extrusion_config_mod, only: extrusion_method_geometric
    implicit none
    class(mesh_test_type), intent(inout) :: this

    real(r_def), parameter :: dz   = 1883.545714005761_r_def
    type (mesh_type) :: mesh_1

    real(r_def) :: dz_test(nlayers)
    real(r_def) :: test_real

    mesh_1 = mesh_type( this%global_mesh, &
                        this%partition,   &
                        nlayers,          &
                        domain_top,       &
                        extrusion_method_geometric)

    dz_test = 0.0_r_def
    call mesh_1%get_dz(dz_test)
    test_real = dz_test(1)
    @assertEqual ( test_real, dz, 1.0e-2_r_def )

  end subroutine test_extrude_geometric

@test 
  subroutine test_extrude_dcmip(this)
    use extrusion_config_mod, only: extrusion_method_dcmip
    implicit none
    class(mesh_test_type), intent(inout) :: this

    real(r_def), parameter :: dz   = 883.0368802245059_r_def
    type (mesh_type) :: mesh_1
    
    real(r_def) :: dz_test(nlayers)
    real(r_def) :: test_real
    
    mesh_1 = mesh_type( this%global_mesh, &
                        this%partition,   &
                        nlayers,          &
                        domain_top,       &
                        extrusion_method_dcmip)
    
    dz_test = 0.0_r_def
    call mesh_1%get_dz(dz_test)
    test_real = dz_test(1)
    @assertEqual ( test_real, dz, 1.0e-2_r_def )

  end subroutine test_extrude_dcmip

  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  @test
  subroutine test_get_integer( this )

    implicit none

    class( mesh_test_type ), intent( inout ) :: this

    type (mesh_type) :: mesh_1

    integer(i_def) :: test_integer

    mesh_1 = mesh_type( this%global_mesh, &
                        this%partition,   &
                        nlayers,          &
                        domain_top,       &
                        extrusion_method_uniform )
     !-------------------------------------------------------------------
    ! Test get_vert_cell_owner
    test_integer=mesh_1%get_vertex_cell_owner(2,4)
    @assertEqual( 5, test_integer )

    !-------------------------------------------------------------------
    ! Test get_edge_cell_owner
    test_integer=mesh_1%get_edge_cell_owner(4,4)
    @assertEqual( 7, test_integer )

    !-------------------------------------------------------------------
    ! Test inner halo cell information
    test_integer=mesh_1%get_inner_depth()
    @assertEqual( 1, test_integer )

    test_integer=mesh_1%get_num_cells_inner(1)
    @assertEqual( 9, test_integer )

    test_integer=mesh_1%get_last_inner_cell(1)
    @assertEqual( 9, test_integer )

    !-------------------------------------------------------------------
    ! Test edge cell information
    test_integer=( mesh_1%get_num_cells_edge() )
    @assertEqual( 0, test_integer )

    test_integer=( mesh_1%get_last_edge_cell() )
    @assertEqual( 9, test_integer )

    !-------------------------------------------------------------------
    ! Test halo information
    test_integer=( mesh_1%get_halo_depth() )
    @assertEqual( 1, test_integer )

    test_integer=( mesh_1%get_num_cells_halo( 1 ) )
    @assertEqual( 0, test_integer )

    test_integer=mesh_1%get_last_halo_cell( 1 )
    @assertEqual( 9, test_integer )

    !-------------------------------------------------------------------
    ! Test get_num_cells_ghost
    test_integer=( mesh_1%get_num_cells_ghost() )
    @assertEqual( 0, test_integer )

    !-------------------------------------------------------------------
    ! Test get_gid_from_lid
    test_integer=( mesh_1%get_gid_from_lid( 1 ) )
    @assertEqual( 1, test_integer )

  end subroutine test_get_integer

  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  @test
  subroutine test_get_boolean( this )

    implicit none

    class( mesh_test_type ), intent( inout ) :: this

    type(mesh_type)     :: mesh_1

    mesh_1 = mesh_type( this%global_mesh, &
                        this%partition,   &
                        nlayers,          &
                        domain_top,       &
                        extrusion_method_uniform )

    !-------------------------------------------------------------------
    ! Test is_vertex_owned
    @assertTrue( mesh_1%is_vertex_owned(1,1) )

    !-------------------------------------------------------------------
    ! Test is_edge_owned
    @assertTrue( mesh_1%is_edge_owned(1,1) )

    !-------------------------------------------------------------------
    ! Test is_vertex_owned
    @assertTrue( mesh_1%is_vertex_owned(1,1) )

  end subroutine test_get_boolean

  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  subroutine test_get_domain( this )

    implicit none

    class( mesh_test_type ), intent( inout ) :: this

    type(mesh_type)     :: mesh_1
    type(domain_size_type) :: domain
    real(r_def)         :: test_real

    mesh_1 = mesh_type( this%global_mesh, &
                        this%partition,   &
                        nlayers,          &
                        domain_top,       &
                        extrusion_method_uniform )

    !-------------------------------------------------------------------
    ! Test get_domain_size
    ! Note: At present, it returns coords in cartesian coords [x,y,z]
    !       or in spherical coords depending on the logical l_spherical.
    !       This should be change to only output in [x,y,z]
    domain = mesh_1%get_domain_size()
    test_real = domain % maximum % x
    @assertEqual ( test_real,  2.0_r_def*PI )
    test_real = domain % minimum % y
    @assertEqual ( test_real, -0.5_r_def*PI )
    test_real = domain % maximum % z
    @assertEqual ( test_real, 10000.0_r_def )

    !-------------------------------------------------------------------
    ! Test get_domain_top
    test_real = mesh_1%get_domain_top()
    @assertEqual ( test_real, domain_top, 1.0e-2_r_def )

  end subroutine test_get_domain

end module mesh_mod_test
