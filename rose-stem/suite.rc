#!jinja2
{%- set science_configurations = 'runge-kutta', 'semi-implicit',
                                 'semi-implicit-360ts', 'si-helmholtz', 
                                 'transport-cosmic', 'transport-rk', 'transport-biperiodic',
                                 'biperiodic_p0_gw', 'biperiodic_p1_gw',
                                 'dcmip301', 'robert', 'robert-moist',
                                 'sbr', 'sbr_spinupwinds', 'sbr_spinupalpha'%}
{%- set groups = {'developer': ['science(semi-implicit)',
                                'science(si-helmholtz)',
                                'science(runge-kutta)',
                                'science(transport-rk)',
                                'science(transport-cosmic)',
                                'science(transport-biperiodic)',
                                'science(biperiodic_p0_gw)',
                                'science(biperiodic_p1_gw)',
                                'miniapp(boundary_test)',
                                'check_compilers(fast-debug)',
                                'canned_test',
                                'godlines',
                                'cleanlines'],
		  'csar':    ['science(robert)',
                              'science(robert, crun=3, env={"nrun":50})',
                              'science(robert-moist)',
                              'science(biperiodic_p0_gw)',
                              'science(dcmip301)',
                              'science(sbr, True, T000060)',
			      'science(sbr_spinupwinds, True, T000060)',
			      'science(sbr_spinupalpha, True, T000060)',],
                  'nightly': ['science(semi-implicit-360ts, True, T000360)',
                              'science(dcmip301, True, T000018)',
                              'science(sbr, False, T000060)',
                              'miniapp(gravity_wave)',
                              'check_compilers(full-debug, True)',
                              'godlines(True)',
                              'publish_index']} %}
{%- set maxnrun = 3 %}
{%- set mesh_types = ['cubedsphere', 'biperiodic'] %}
{%- set ts_config = {} %}
{%- set compiler_setup = {} -%}
{%- for compiler, setup in TARGET_COMPILER_SETUP|batch(2) -%}
{%-     do compiler_setup.update({compiler : [setup]}) -%}
{%- endfor -%}

{%- if RUN_NAMES is defined %}
{%-   if RUN_NAMES is string %}
{%-     set groupsToRun = [RUN_NAMES] %}
{%-   else %}
{%-     set groupsToRun = RUN_NAMES %}
{%-   endif %}
{%- else %}
{%-   set groupsToRun = ['developer'] %}
{%- endif %}

{#- #########################################################################}
{%-   set SCIENCE_LABEL =  TARGET_SCIENCE_COMPILER + '_fast-debug' %}
{%- macro science( configuration, plotting=False, timestep='T000360', crun=0, env=None ) %}
{%-   set label = SCIENCE_LABEL %}
{%- if crun > 1 %}
            run_{{configuration}}_{{label}}[-P1]:finish => run_{{configuration}}_{{label}}
            run_{{configuration}}_{{label}}[{{crun}}]:finish => !run_{{configuration}}_{{label}}
{%- else %}
            purge_local => purge_target
            purge_target => export_for_{{label}}
            export_for_{{label}} => compile_with_{{label}}
{%-   if TARGET_SCIENCE_COMPILER in TARGET_PERFORM_RUN %}
            compile_with_{{label}} => run_{{configuration}}_{{label}}
{%-     if TARGET_SCIENCE_COMPILER in TARGET_PERFORM_KGO_TESTS %}
            run_{{configuration}}_{{label}} => check_{{configuration}}_{{label}}
{%-     endif %}
{%-   endif %}
{%-   if plotting %}
{%-     do ts_config.update( {configuration : timestep} ) %}
            run_{{configuration}}_{{label}} => plot_{{configuration}}_{{label}}
            plot_{{configuration}}_{{label}} => copy_results_{{configuration}}_{{label}}
{%-   endif %}
{%-   endif %}
{%- endmacro %}
{#- #########################################################################}
{%- macro canned_test() %}
{%-   set label = TARGET_SCIENCE_COMPILER | lower + '_' + 'fast-debug' %}
{%-   if TARGET_SCIENCE_COMPILER in TARGET_PERFORM_RUN %}
            purge_local => purge_target
            purge_target => export_for_{{label}}
            export_for_{{label}} => compile_with_{{label}}
            compile_with_{{label}} => run_canned_test_{{label}}
{%-   endif %}
{%- endmacro %}
{#- #########################################################################}
{%- macro miniapp( appname ) %}
{%-   set label = TARGET_SCIENCE_COMPILER|lower + '_fast-debug' %}
            purge_local => purge_target
            purge_target => export_for_{{label}}
            export_for_{{label}} => compile_with_{{label}}
{%-   if TARGET_SCIENCE_COMPILER in TARGET_PERFORM_RUN %}
            compile_with_{{label}} => run_{{label}}_{{appname}}
{%-     if TARGET_SCIENCE_COMPILER in TARGET_PERFORM_KGO_TESTS %}
            run_{{label}}_{{appname}} => check_{{label}}_{{appname}}
{%-     endif %}
{%-   endif %}
{%- endmacro %}
{#- #########################################################################}
{%- macro cleanlines() %}
{%-   set label =  TARGET_TECHNICAL_COMPILER | lower + '_fast-debug' %}
{%-   if 'cleanliness' in TECHNICAL_DEVELOPER_TESTS %}
            purge_local => purge_target
            purge_target => export_for_{{label}}
            export_for_{{label}} => compile_with_{{label}}
{#- The following line removed due to a bug brought to light by #730. #}
{#- Ticket #762 has been created to fix this.                         #}
{#-            compile_with_{{label}} => check_for_unused_source #}
{%-   endif %}
{%- endmacro %}
{#- Documentation, it's next to cleanlines ##################################}
{%- macro godlines(publish=False) %}
{%-   set label =  TARGET_TECHNICAL_COMPILER | lower + '_fast-debug' %}
{%-   if 'documentation' in TECHNICAL_DEVELOPER_TESTS %}
            purge_local => purge_target
            purge_target => export_for_{{label}}
            export_for_{{label}} => api_documentation
            export_for_{{label}} => design_documentation
{%-     if publish %}
            api_documentation    => publish_api_documentation
            api_documentation    => publish_api_log
            design_documentation => publish_design_documentation
{%-     endif %}
{%-   endif %}
{%- endmacro %}
{#- #########################################################################}
{%- macro publish_index() %}
            PUBLISH:finish-all => publish_index
{%- endmacro %}
{#- #########################################################################}
{%- macro check_compilers( build, publish=False ) %}
{%-   for compiler in compiler_setup.keys() %}
{%-     set label = compiler | lower + '_' + build | lower%}
{%-     set perform_run = TARGET_PERFORM_RUN %}
{%-     if build == 'full-debug' and TARGET_PERFORM_DEBUG_RUN is defined %}
{%-       set perform_run = TARGET_PERFORM_DEBUG_RUN %}
{%-     endif %}
            purge_local => purge_target
            purge_target => export_for_{{label}}
            export_for_{{label}} => compile_with_{{label}}
{%-     if publish %}
            compile_with_{{label}}:finish => publish_{{label}}_compile
{%-     endif %}
{%-     if compiler in perform_run %}
{%-       for mesh in mesh_types %}
            compile_with_{{label}} => generate_mesh_{{mesh}}_{{label}}
{%-         if compiler in TARGET_PERFORM_KGO_TESTS %}
            generate_mesh_{{mesh}}_{{label}} => check_mesh_{{mesh}}_{{label}}
{%-         endif %}
{%-       endfor %}
{%-       if compiler in TARGET_PERFORM_UNIT_TESTS %}
            compile_with_{{label}} => unit_test_with_{{label}}
{%-       endif %}
{%-       if compiler in TARGET_PERFORM_FUNCTIONAL_TESTS %}
            compile_with_{{label}} => functional_test_with_{{label}}
{%-       endif %}
            compile_with_{{label}} => run_semi-implicit_{{label}}
{%-       if publish %}
            run_semi-implicit_{{label}}:finish => publish_{{label}}_semi-implicit
{%-       endif %}
{%-       if compiler in TARGET_PERFORM_KGO_TESTS %}
            run_semi-implicit_{{label}} => check_semi-implicit_{{label}}
{%-       endif %}
{%-     endif %}
{%-   endfor %}
{%- endmacro %}
{#- #########################################################################}
{%- macro schedule(is_crun=False) %}
{%-   for group in groupsToRun %}
{%-       for mission in groups[group] %}
{{          mission | executeMacro(is_crun) }}
{%-       endfor %}
{%-   endfor %}
{%- endmacro %}
{#- #########################################################################}
{%- macro setTaskEnv(scheduledTasksEnv) %}
{%-   for group in groupsToRun %}
{%-       for mission in groups[group] %}
{%-           set k,v = mission | getEnvMacro() %}
{%-       if k is not none %}
{%            set key = k + '_' + SCIENCE_LABEL %} 
{%-           do scheduledTasksEnv.update({key : v})  -%}
{%-       endif %}
{%-       endfor %}
{%-   endfor %}
{%- endmacro %}


[cylc]
    UTC mode = True
    [[events]]
        mail events = timeout
        abort on timeout = True
{%- if 'nightly' in groupsToRun %}
        abort on stalled = True
{%- endif %}
        timeout = PT3H

[scheduling]
    cycling mode        = integer
    initial cycle point = 1
    final cycle point   = {{ maxnrun }}
    [[queues]]
        [[[host_throttle]]]
            limit = {{ TARGET_THROTTLE }}
            members = root
    [[dependencies]]
        [[[R1]]]
            graph = """
{%- set scheduledTasks = schedule(is_crun=false) | deduplicateSchedule() %}
{{scheduledTasks}}
                    """
        [[[P1]]]
            graph = """
{%- set scheduledCrunTasks = schedule(is_crun=true) | deduplicateSchedule() %}
{{scheduledCrunTasks}}
                    """
[runtime]
    [[root]]
        initial scripting = """
                            export CYLC_VERSION={{CYLC_VERSION}}
                            export ROSE_VERSION={{ROSE_VERSION}}
                            """
        script = "rose task-run"
        [[[events]]]
{%- if TROUBLE_MAIL_ADDRESS is defined %}
            mail to = {{TROUBLE_MAIL_ADDRESS}}
            mail events = submission timeout, submission failed, timeout, failed, execution timeout
{%- endif %}
            submission timeout = PT12H
            execution timeout  =  PT3H
        [[[environment]]]
            SOURCE_ROOT = $CYLC_SUITE_SHARE_DIR/source
            OUTPUT_ROOT = $CYLC_SUITE_SHARE_DIR/output

    [[ LOCAL ]]
        [[[remote]]]
            host = {{ ROSE_ORIG_HOST }}
        [[[job]]]
            batch system = background

    [[TARGET]]
        [[[remote]]]
            host = {{TARGET_HOST}}
        [[[job]]]
            batch system = {{TARGET_BATCHER}}

{%- set scheduledTasksEnv = {} %}
{%- set dummy = setTaskEnv(scheduledTasksEnv) -%}
{%- macro ensureDestination() %}
                     mkdir -p $DESTINATION
                     chmod 755 $DESTINATION
{%- endmacro %}
    [[PUBLISH]]
        [[[environment]]]
            DESTINATION = ~/public_html/dynamo-{{TARGET_OPT}}

##############################################################################
    [[purge_local]]
        inherit = None, LOCAL
        script = rm -rf $OUTPUT_ROOT/* $SOURCE_ROOT/*

    # The build directives are used to ensure that any temporary space which
    # might be used for building is available to be cleaned.
    [[purge_target]]
        inherit = None, TARGET
        script = rm -rf {{TARGET_BUILD_ROOT}}/* $OUTPUT_ROOT/* $SOURCE_ROOT/*
        [[[directives]]]
{%- for DIRECTIVE in TARGET_BUILD_BATCHER_DIRECTIVES %}
            {{DIRECTIVE}}
{%- endfor %}

{%- if 'publish_index' in scheduledTasks %}
    # This task can not be part of the PUBLISH family as a prerequisite of
    # running it is that the PUBLISH family have completed. i.e. A circular
    # dependency. This means it can not take advantage of the environment set
    # up by the family. That is why some items are duplicated.
    [[publish_index]]
        inherit = None, LOCAL
        script = rose task-run --app-key=publish --command-key=index
        [[[environment]]]
            DESTINATION = ~/public_html/dynamo-{{TARGET_OPT}}
{%-   if ROSE_BUSH_URL %}
            ROSE_BUSH_ARG = -bush {{ROSE_BUSH_URL}}
{%-   endif %}
{%- endif %}

##############################################################################
    [[TECHNICAL]]
        [[[environment]]]
            DYNAMO_SOURCE_DIRECTORY      = $SOURCE_ROOT/{{TARGET_TECHNICAL_COMPILER}}_fast-debug
            DYNAMO_DESTINATION_DIRECTORY = $OUTPUT_ROOT/{{TARGET_TECHNICAL_COMPILER}}_fast-debug
            DYNAMO_BUILD_ROOT            = {{TARGET_BUILD_ROOT}}/{{TARGET_TECHNICAL_COMPILER}}_fast-debug

{%- if 'check_for_unused_source' in scheduledTasks %}
    [[check_for_unused_source]]
        inherit = None, TARGET, TECHNICAL
        pre-script = """
                     {{'\n'|commandList(LOCAL_BASE_SETUP, LOCAL_TECHNICAL_SETUP, LOCAL_REVEAL_SETUP, "mkdir -p $DYNAMO_BUILD_ROOT", "cp -rp $DYNAMO_SOURCE_DIRECTORY/build/* $DYNAMO_BUILD_ROOT")}}
                     """
        script = make -C $DYNAMO_SOURCE_DIRECTORY/src/dynamo unused-check
        post-script = rm -rf $DYNAMO_BUILD_ROOT
        [[[directives]]]
{%-   for DIRECTIVE in TARGET_TECHNICAL_BATCHER_DIRECTIVES %}
            {{DIRECTIVE}}
{%-   endfor %}
{%- endif %}

    # Run locally as they need workstation tools such as Doxygen.
{%- if 'api_documentation' in scheduledTasks %}
    [[api_documentation]]
        inherit = None, LOCAL, TECHNICAL
        pre-script = """
                     {{'\n'|commandList( LOCAL_BASE_SETUP, LOCAL_REVEAL_SETUP, 'mkdir -p $DYNAMO_DESTINATION_DIRECTORY') }}
                     """
        script = make -C $DYNAMO_SOURCE_DIRECTORY/documentation api-documents
        post-script = """
                      # Future publisher stages need this information
                      echo $CYLC_TASK_LOG_ROOT > $DYNAMO_DESTINATION_DIRECTORY/api.doxygen.log.path
                      """
{%- endif %}

{%- if 'publish_api_log' in scheduledTasks %}
    [[publish_api_log]]
        inherit = PUBLISH, TECHNICAL, LOCAL
        pre-script = """
{{ensureDestination()}}
                     cp `cat $DYNAMO_DESTINATION_DIRECTORY/api.doxygen.log.path`.out $DYNAMO_DESTINATION_DIRECTORY/api.doxygen.out
                     cp `cat $DYNAMO_DESTINATION_DIRECTORY/api.doxygen.log.path`.err $DYNAMO_DESTINATION_DIRECTORY/api.doxygen.err
                     """
        script = rose task-run --app-key=publish --command-key=doxygen
        [[[environment]]]
            LOG_OUT = $DYNAMO_DESTINATION_DIRECTORY/api.doxygen.out
            LOG_ERR = $DYNAMO_DESTINATION_DIRECTORY/api.doxygen.err
{%- endif %}

{%- if 'publish_api_documentation' in scheduledTasks %}
    [[publish_api_documentation]]
        inherit = PUBLISH, LOCAL, TECHNICAL
        pre-script = """
{{ensureDestination()}}
                     """
        script = rose task-run --app-key=publish --command-key=directory
        [[[environment]]]
            DIRECTORY = $DYNAMO_SOURCE_DIRECTORY/documentation/api
{%- endif %}

    # Run locally as they need workstation tools like Inkscape.
{%- if 'design_documentation' in scheduledTasks %}
    [[design_documentation]]
        inherit = None, LOCAL, TECHNICAL
        pre-script = """
                     {{'\n'|commandList( LOCAL_BASE_SETUP, LOCAL_REVEAL_SETUP) }}
                     """
        script = make -C $DYNAMO_SOURCE_DIRECTORY/documentation design-documents.tar
{%- endif %}

{%- if 'publish_design_documentation' in scheduledTasks %}
    [[publish_design_documentation]]
        inherit = PUBLISH, LOCAL, TECHNICAL
        pre-script = """
{{ensureDestination()}}
                     """
        script = rose task-run --app-key=publish --command-key=tar-file
        [[[environment]]]
            FILE = $DYNAMO_SOURCE_DIRECTORY/documentation/design-documents.tar
            DESTINATION = ~/public_html/dynamo-{{TARGET_OPT}}/design
{%- endif %}

##############################################################################

{%- for compiler in compiler_setup.keys() -%}
{%-   for build in 'fast-debug', 'full-debug' %}
{%-     set label = compiler | lower + '_' + build | lower %}
{%-     set family = label | upper %}
    [[{{family}}]]
        [[[environment]]]
            DYNAMO_SOURCE_DIRECTORY      = $SOURCE_ROOT/{{label}}
            DYNAMO_DESTINATION_DIRECTORY = $OUTPUT_ROOT/{{label}}
            DYNAMO_COMPILER              = {{compiler}}
            {#- We can't define DYNAMO_BUILD_ROOT here as it may contain    #}
            {#- target specific variables not existing on the local machine #}

    # Export must be performed locally as it needs access to any working copy
    # involved. Such a working copy may well be on a local disc.
    #
{%- if 'export_for_' + label in scheduledTasks %}
    [[export_for_{{label}}]]
        inherit = {{family}}, LOCAL
        script = """
                 mkdir -p `dirname $DYNAMO_SOURCE_DIRECTORY`
                 svn export {{ SOURCE_DYNAMO }} $DYNAMO_SOURCE_DIRECTORY
                 HOST={{TARGET_HOST}}
                 DYNAMO_RELATIVE_SOURCE_DIRECTORY=`echo $DYNAMO_SOURCE_DIRECTORY | sed "s|$HOME/||"`
                 ssh $HOST mkdir -p $DYNAMO_RELATIVE_SOURCE_DIRECTORY
                 rsync -avz $DYNAMO_SOURCE_DIRECTORY/ $HOST:$DYNAMO_RELATIVE_SOURCE_DIRECTORY/
                 """
{%- endif %}

{%- if 'compile_with_' + label in scheduledTasks %}
    [[compile_with_{{label}}]]
        inherit = {{family}}, TARGET
        pre-script = """
                     {{'\n'|commandList(TARGET_BASE_SETUP, compiler_setup[compiler], TARGET_BUILD_SETUP, TARGET_REVEAL_SETUP, 'rm -rf $DYNAMO_BUILD_ROOT/*')}}
                     """
        script      = rose task-run --app-key=compile
        post-script = """
                      cp -rp $DYNAMO_BUILD_ROOT $DYNAMO_SOURCE_DIRECTORY/build
                      rm -rf $DYNAMO_BUILD_ROOT
                      # Future publisher stages need this information
                      echo $CYLC_TASK_LOG_ROOT > $DYNAMO_DESTINATION_DIRECTORY/dynamo.{{compiler}}.log.path
                      """
        [[[environment]]]
            DYNAMO_BUILD_ROOT           = {{TARGET_BUILD_ROOT}}/{{label}}
            BUILD_TARGET                = {{build}}
            DYNAMO_OPTIMISATION_PROFILE = {{TARGET_OPT}}
        [[[directives]]]
{%-   for DIRECTIVE in TARGET_BUILD_BATCHER_DIRECTIVES %}
            {{DIRECTIVE}}
{%-   endfor %}
{%- endif %}

{%- if 'publish_' + label + '_compile' in scheduledTasks %}
    [[publish_{{label}}_compile]]
        inherit = PUBLISH, {{family}}, LOCAL
        pre-script = """
{{ensureDestination()}}
                     mkdir -p $DYNAMO_DESTINATION_DIRECTORY
                     RELATIVE_DESTINATION_DIRECTORY=`echo $DYNAMO_DESTINATION_DIRECTORY | sed "s|$HOME/||"`
                     scp {{TARGET_HOST}}:$RELATIVE_DESTINATION_DIRECTORY/dynamo.{{compiler}}.log.path .
                     scp {{TARGET_HOST}}:`cat dynamo.{{compiler}}.log.path`.out $DYNAMO_DESTINATION_DIRECTORY/dynamo.{{compiler}}.out
                     scp {{TARGET_HOST}}:`cat dynamo.{{compiler}}.log.path`.err $DYNAMO_DESTINATION_DIRECTORY/dynamo.{{compiler}}.err
                     """
        script = rose task-run --app-key=publish --command-key=compile
        [[[environment]]]
            CONTEXT  = {{build}}
            COMPILER = {{compiler}}
            LOG_OUT  = $DYNAMO_DESTINATION_DIRECTORY/dynamo.{{compiler}}.out
            LOG_ERR  = $DYNAMO_DESTINATION_DIRECTORY/dynamo.{{compiler}}.err
{%- endif %}

{%-     if 'run_canned_test_' + label in scheduledTasks %}
    [[run_canned_test_{{label}}]]
        inherit = {{family}}, TARGET
        pre-script = """
                     {{'\n'|commandList(TARGET_BASE_SETUP, compiler_setup[compiler], TARGET_RUN_SETUP, TARGET_REVEAL_SETUP)}}
                     """
        script = rose task-run --app-key=canned_test --command-key={{TARGET_RUN_METHOD}}
        [[[environment]]]
            DYNAMO_SOURCE_DIRECTORY = $SOURCE_ROOT/{{label}}
        [[[environment]]]
            OMP_NUM_THREADS=2
        [[[directives]]]
{%-       for DIRECTIVE in TARGET_RUN_BATCHER_DIRECTIVES %}
            {{DIRECTIVE}}
{%-       endfor %}
{%-     endif %}

{%-     for configuration in science_configurations %}
{%-       set configuration_label = configuration|lower + '_' + label %}
{%-       if 'run_' + configuration_label in scheduledTasks %}
    [[run_{{configuration_label}}]]
        inherit = {{family}}, TARGET
        pre-script = """
                     {{'\n'|commandList(TARGET_BASE_SETUP, compiler_setup[compiler], TARGET_RUN_SETUP, TARGET_REVEAL_SETUP)}}
                     """
        script = rose task-run --app-key=dynamo --command-key={{TARGET_RUN_METHOD}} --opt-conf-key={{configuration}}
        post-script = """
                      cp dynamo-checksums.txt $DYNAMO_DESTINATION_DIRECTORY/dynamo.{{configuration}}.{{compiler}}.checksums
                      mkdir -p $DYNAMO_DESTINATION_DIRECTORY/{{configuration}}/results
                      cp $CYLC_TASK_WORK_DIR/diagDynamo*.m $DYNAMO_DESTINATION_DIRECTORY/{{configuration}}/results/
                      # Future publisher stages need this information
                      echo $CYLC_TASK_LOG_ROOT > $DYNAMO_DESTINATION_DIRECTORY/dynamo.{{configuration}}.{{compiler}}.log.path
                      """
        [[[environment]]]
            OMP_NUM_THREADS=2
{% if configuration_label in scheduledTasksEnv.keys() %}
{{          scheduledTasksEnv[configuration_label] }}
{% endif %}
            RESTART_NTS   = $(echo ${nrun:-1})
            RESTART_NO    = $(echo $[$CYLC_TASK_CYCLE_POINT -1])
            RESTART       = $(if [ $CYLC_TASK_CYCLE_POINT == $CYLC_SUITE_INITIAL_CYCLE_POINT ] && [ $CYLC_TASK_TRY_NUMBER -eq 1 ]; then echo ""; else echo "true"; fi)
            RESTART_START = $(echo $[$RESTART_NO*$RESTART_NTS + 1])
            RESTART_STOP  = $(echo $[$RESTART_NO*$RESTART_NTS + $RESTART_NTS])
            RESTART_READ  = $(if [[ $RESTART ]]; then echo ".true."; else echo ".false."; fi) 

        [[[directives]]]
{%-         for DIRECTIVE in TARGET_RUN_BATCHER_DIRECTIVES %}
            {{DIRECTIVE}}
{%-         endfor %}
{%-       endif %}

{%-       if 'plot_' + configuration_label in scheduledTasks %}
{%-         set ts_label = configuration %}
    [[plot_{{configuration_label}}]]
        inherit = PUBLISH, {{family}}, TARGET
        pre-script = """
 {{ensureDestination()}}
                     mkdir -p ~/public_html/dynamo-{{TARGET_OPT}}/model_output/{{configuration_label}}
                     chmod 755 ~/public_html/dynamo-{{TARGET_OPT}}/model_output/{{configuration_label}}
                     mkdir -p ~/public_html/dynamo-{{TARGET_OPT}}/model_output/{{configuration_label}}/plots
                     chmod 755 ~/public_html/dynamo-{{TARGET_OPT}}/model_output/{{configuration_label}}/plots
                     chmod 755 ~/public_html/dynamo-{{TARGET_OPT}}/model_output
                     # remove old plots before running new ones
                     rm -rf $PLOT_DIR/*.png
                     """
        script = rose task-run --app-key=plot
        post-script = """
                      chmod 754 $PLOT_DIR/*.png
                      """
        [[[environment]]]
             NODAL_DATA_DIR = $DYNAMO_DESTINATION_DIRECTORY/{{configuration}}/results/
             PLOT_DIR = ~/public_html/dynamo-{{TARGET_OPT}}/model_output/{{configuration_label}}/plots
             FIELDS = theta,rho
             TS = {{ts_config[ts_label]}}

{%-       endif %}

    # Copy of model results back to user's public_html must be performed locally as the target machine may
    # not allow outgoing ssh connections
{%-       if 'copy_results_' + configuration_label in scheduledTasks %}
    [[copy_results_{{configuration_label}}]]
        inherit = PUBLISH, {{family}}, LOCAL
        pre-script = """
{{ensureDestination()}}
                     """
        script = scp -pr {{TARGET_HOST}}:public_html/dynamo-{{TARGET_OPT}}/model_output ~/public_html/dynamo-{{TARGET_OPT}}
{%- endif %}

{%-       if 'publish_' + label + '_' +  configuration|lower in scheduledTasks %}
    [[publish_{{label}}_{{configuration|lower}}]]
        inherit = PUBLISH, {{family}}, LOCAL
        pre-script = """
{{ensureDestination()}}
                     mkdir -p $DYNAMO_DESTINATION_DIRECTORY
                     RELATIVE_DESTINATION_DIRECTORY=`echo $DYNAMO_DESTINATION_DIRECTORY | sed "s|$HOME/||"`
                     scp {{TARGET_HOST}}:$RELATIVE_DESTINATION_DIRECTORY/dynamo.{{configuration}}.{{compiler}}.log.path .
                     scp {{TARGET_HOST}}:`cat dynamo.{{configuration}}.{{compiler}}.log.path`.out $DYNAMO_DESTINATION_DIRECTORY/dynamo.{{configuration}}.{{compiler}}.out
                     scp {{TARGET_HOST}}:`cat dynamo.{{configuration}}.{{compiler}}.log.path`.err $DYNAMO_DESTINATION_DIRECTORY/dynamo.{{configuration}}.{{compiler}}.err
                     """
        script = rose task-run --app-key=publish --command-key=run
        [[[environment]]]
            CONTEXT       = {{build}}
            CONFIGURATION = {{configuration}}
            COMPILER      = {{compiler}}
            LOG_OUT       = $DYNAMO_DESTINATION_DIRECTORY/dynamo.{{configuration}}.{{compiler}}.out
            LOG_ERR       = $DYNAMO_DESTINATION_DIRECTORY/dynamo.{{configuration}}.{{compiler}}.err
{%-       endif %}

{%-       if 'check_' + configuration_label in scheduledTasks %}
    [[check_{{configuration_label}}]]
        inherit = {{family}}, TARGET
        script = rose task-run --app-key=check_dynamo
        [[[environment]]]
            TARGET_OPT = {{TARGET_OPT}}
            DYNAMO_CONFIG = {{configuration}}
        [[[directives]]]
{%-         for DIRECTIVE in TARGET_TECHNICAL_BATCHER_DIRECTIVES %}
            {{DIRECTIVE}}
{%-         endfor %}
{%-       endif %}
{%-     endfor %}{# science configurations #}

{%-     if 'run_' + label + '_boundary_test' in scheduledTasks %}
    [[run_{{label}}_boundary_test]]
        inherit = {{family}}, TARGET
        pre-script = """
                     {{'\n'|commandList(TARGET_BASE_SETUP, compiler_setup[compiler], TARGET_RUN_SETUP, TARGET_REVEAL_SETUP)}}
                     """
        script = rose task-run --app-key=boundary_test --command-key={{TARGET_RUN_METHOD}}
        post-script = cp boundary_test-checksums.txt $DYNAMO_DESTINATION_DIRECTORY/boundary_test.{{compiler}}.checksums.txt
        [[[environment]]]
            OMP_NUM_THREADS=2
        [[[directives]]]
{%-         for DIRECTIVE in TARGET_RUN_BATCHER_DIRECTIVES %}
            {{DIRECTIVE}}
{%-         endfor %}
{%-       endif %}

{%-     if 'check_' + label + '_boundary_test' in scheduledTasks %}
    [[check_{{label}}_boundary_test]]
        inherit = {{family}}, TARGET
        script = rose task-run --app-key=check_boundary
{%-       endif %}

{%-     if 'run_' + label + '_gravity_wave' in scheduledTasks %}
    [[run_{{label}}_gravity_wave]]
        inherit = {{family}}, TARGET
        pre-script = """
                     {{'\n'|commandList(TARGET_BASE_SETUP, compiler_setup[compiler], TARGET_RUN_SETUP, TARGET_REVEAL_SETUP)}}
                     """
        script = rose task-run --app-key=gravity_wave --command-key={{TARGET_RUN_METHOD}}
        post-script = cp gravity_wave-checksums.txt $DYNAMO_DESTINATION_DIRECTORY/gravity_wave.{{compiler}}.checksums
        [[[environment]]]
            OMP_NUM_THREADS=2
        [[[directives]]]
{%-         for DIRECTIVE in TARGET_RUN_BATCHER_DIRECTIVES %}
            {{DIRECTIVE}}
{%-         endfor %}
{%-       endif %}

{%-     if 'check_' + label + '_gravity_wave' in scheduledTasks %}
    [[check_{{label}}_gravity_wave]]
        inherit = {{family}}, TARGET
        script = rose task-run --app-key=check_gravity_wave
        [[[environment]]]
            TARGET_OPT = {{TARGET_OPT}}
        [[[directives]]]
{%-         for DIRECTIVE in TARGET_TECHNICAL_BATCHER_DIRECTIVES %}
            {{DIRECTIVE}}
{%-         endfor %}
{%-       endif %}

{%-     if 'unit_test_with_' + label in scheduledTasks %}
    [[unit_test_with_{{label}}]]
        inherit = {{family}}, TARGET
        pre-script = """
                     {{'\n'|commandList(TARGET_BASE_SETUP, compiler_setup[compiler], TARGET_BUILD_SETUP, TARGET_REVEAL_SETUP, "mkdir -p $DYNAMO_BUILD_ROOT", "cp -rp $DYNAMO_SOURCE_DIRECTORY/build/* $DYNAMO_BUILD_ROOT")}}
                     """
        script = make -C $DYNAMO_SOURCE_DIRECTORY/src/test
        post-script = """
                      {{'\n'|commandList("cp -rp $DYNAMO_BUILD_ROOT/* $DYNAMO_SOURCE_DIRECTORY/build", "rm -rf $DYNAMO_BUILD_ROOT")}}
                      """
        [[[environment]]]
            DYNAMO_BUILD_ROOT = {{TARGET_BUILD_ROOT}}/{{label}}
        [[[directives]]]
{%-       for DIRECTIVE in TARGET_BUILD_BATCHER_DIRECTIVES %}
            {{DIRECTIVE}}
{%-       endfor %}
{%-     endif %}

{%-     if 'functional_test_with_' + label in scheduledTasks %}
    [[functional_test_with_{{label}}]]
        inherit = {{family}}, TARGET
        pre-script = """
                     {{'\n'|commandList(TARGET_BASE_SETUP, compiler_setup[compiler], TARGET_BUILD_SETUP, TARGET_REVEAL_SETUP, "mkdir -p $DYNAMO_BUILD_ROOT", "cp -rp $DYNAMO_SOURCE_DIRECTORY/build/* $DYNAMO_BUILD_ROOT")}}
                     """
        script = make -C $DYNAMO_SOURCE_DIRECTORY/src/functional-test
        post-script = """
                      {{'\n'|commandList("cp -rp $DYNAMO_BUILD_ROOT/* $DYNAMO_SOURCE_DIRECTORY/build", "rm -rf $DYNAMO_BUILD_ROOT")}}
                      """
        [[[environment]]]
            DYNAMO_BUILD_ROOT = {{TARGET_BUILD_ROOT}}/{{label}}
        [[[directives]]]
{%-       for DIRECTIVE in TARGET_BUILD_BATCHER_DIRECTIVES %}
            {{DIRECTIVE}}
{%-       endfor %}
{%-     endif %}

{%-     for mesh in mesh_types %}
{%-       if 'generate_mesh_' + mesh + '_' + label in scheduledTasks %}
    [[generate_mesh_{{mesh}}_{{label}}]]
        inherit = {{family}}, TARGET
        pre-script = """
                     {{'\n'|commandList(TARGET_BASE_SETUP, compiler_setup[compiler], TARGET_BUILD_SETUP, TARGET_REVEAL_SETUP)}}
                     """
        script = "rose task-run --app-key=mesh --opt-conf-key={{mesh}}"
        [[[environment]]]
            OUTPUT_FILE = $DYNAMO_DESTINATION_DIRECTORY/{{mesh}}.nc
        [[[directives]]]
{%-         for DIRECTIVE in TARGET_RUN_BATCHER_DIRECTIVES %}
            {{DIRECTIVE}}
{%-         endfor %}
{%-       endif %}

{%-       if 'check_mesh_' + mesh + '_' + label in scheduledTasks %}
    [[check_mesh_{{mesh}}_{{label}}]]
        inherit = {{family}}, TARGET
        pre-script = """
                     {{'\n'|commandList(TARGET_BASE_SETUP, compiler_setup[compiler], TARGET_REVEAL_SETUP)}}
                     """
        script = rose task-run --app-key=check_{{mesh}}
        [[[environment]]]
            MESH_FILE = $DYNAMO_DESTINATION_DIRECTORY/{{mesh}}.nc
        [[[directives]]]
{%-         for DIRECTIVE in TARGET_TECHNICAL_BATCHER_DIRECTIVES %}
            {{DIRECTIVE}}
{%-         endfor %}
{%-       endif %}
{%-     endfor %}
{%-   endfor %}
{%- endfor %}
